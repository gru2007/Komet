name: Build Linux AUR Package

on:
  workflow_dispatch:
  workflow_call:
  push:
    branches:
      - main
      - master
    paths:
      - 'lib/**'
      - 'linux/**'
      - 'pubspec.yaml'
      - 'packaging/linux/PKGBUILD'
      - '.github/workflows/build-linux-aur.yml'
  pull_request:
    paths:
      - 'lib/**'
      - 'linux/**'
      - 'pubspec.yaml'
      - 'packaging/linux/PKGBUILD'
      - '.github/workflows/build-linux-aur.yml'

jobs:
  build-linux-aur:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v3

      - name: Get version from pubspec.yaml
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | cut -d'+' -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Install build dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git clang cmake ninja pkg-config gtk3 libsecret curl unzip xz

      - name: Install Flutter
        run: |
          git clone https://github.com/flutter/flutter.git -b stable --depth 1 /opt/flutter
          echo "/opt/flutter/bin" >> $GITHUB_PATH

      - name: Setup Flutter
        run: |
          export PATH="/opt/flutter/bin:$PATH"
          flutter doctor

      - name: Get dependencies
        run: |
          export PATH="/opt/flutter/bin:$PATH"
          flutter pub get

      - name: Build Linux
        run: |
          export PATH="/opt/flutter/bin:$PATH"
          flutter build linux --release

      - name: Generate PKGBUILD with version
        run: |
          VERSION=${{ steps.version.outputs.version }}
          sed "s/\${VERSION}/${VERSION}/g" packaging/linux/PKGBUILD > PKGBUILD
          cat PKGBUILD

      - name: Create source archive
        run: |
          VERSION=${{ steps.version.outputs.version }}
          # Create tarball for AUR
          mkdir -p komet-aur
          cp PKGBUILD komet-aur/
          cp packaging/linux/komet.desktop komet-aur/
          cp -r build/linux/x64/release/bundle komet-aur/bundle
          tar -czvf komet-aur-${VERSION}.tar.gz komet-aur/

      - name: Upload AUR PKGBUILD artifact
        uses: actions/upload-artifact@v4
        with:
          name: komet-linux-aur-${{ steps.version.outputs.version }}
          path: |
            PKGBUILD
            komet-aur-${{ steps.version.outputs.version }}.tar.gz
          retention-days: 30
